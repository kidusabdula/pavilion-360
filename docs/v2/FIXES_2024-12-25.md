# Image Upload & Rental Fixes - Summary

## Issues Fixed

### 1. âœ… Image Upload RLS Policy Error
**Problem:** When uploading images, you got the error:
```
Upload failed: new row violates row-level security policy
```

**Root Cause:** The media upload API was using the regular Supabase client which respects Row Level Security (RLS) policies. The `media` table has RLS enabled and only allows admins to insert records.

**Solution:** Updated the upload API route to use the admin client (with service role key) which bypasses RLS policies.

**Files Changed:**
- `app/api/cms/media/upload/route.ts` - Now uses `createAdminClient()` instead of `createClient()`

**Required:** Ensure you have the `SUPABASE_SERVICE_ROLE_KEY` environment variable set in your `.env.local` file.

---

### 2. âœ… Double-Click Upload Issue
**Problem:** When clicking "Upload Image", a dialog appeared with another oversized upload area, requiring a second click to access the file explorer.

**Solution:** Modified the ImageUpload component to:
- Directly open the file explorer on the first click
- Added a small "Or use URL instead" link below the upload button for users who want to paste a URL
- The dialog now only appears when you click "Replace" on an existing image or click "Or use URL instead"

**Files Changed:**
- `components/cms/forms/image-upload.tsx` - Simplified the upload flow

---

### 3. âœ… Missing `daily_rate` Column
**Problem:** Creating or editing rental items failed with:
```
Could not find the 'daily_rate' column of 'rental_items' in the schema cache
```

**Root Cause:** The rental form includes a `daily_rate` field, but this column was missing from the `rental_items` table in the database.

**Solution:** 
1. Created a migration SQL file to add the column
2. Updated the main schema file for future reference

**Files Created/Changed:**
- `docs/v2/migrations/add-daily-rate-to-rentals.sql` - Migration to add the column
- `docs/v2/SCHEMA_V1.sql` - Updated schema documentation

---

## Next Steps

### 1. Run the Database Migration

Execute the migration in your Supabase SQL Editor:

```sql
-- Add daily_rate column to rental_items table
ALTER TABLE rental_items 
ADD COLUMN daily_rate VARCHAR(50);
```

Or run the full migration file at: `docs/v2/migrations/add-daily-rate-to-rentals.sql`

### 2. Regenerate TypeScript Types

After running the migration, regenerate your TypeScript types:

```bash
pnpm supabase:types
```

### 3. Verify Environment Variables

Make sure you have the following in your `.env.local` file:

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

**Important:** The service role key should NEVER be exposed to the client. It's only used in secure server-side contexts (API routes).

### 4. Test the Fixes

1. **Test Image Upload:**
   - Go to any CMS form with an image upload
   - Click the upload area - it should directly open your file explorer
   - Select an image and verify it uploads successfully
   - Try the "Or use URL instead" option

2. **Test Rental Creation:**
   - Go to CMS â†’ Rentals â†’ New
   - Fill in the form including the daily rate
   - Submit and verify it saves successfully

---

## Technical Details

### Admin Client Usage
The admin client (`lib/supabase/admin.ts`) uses the service role key to bypass RLS policies. This is necessary for:
- Media uploads (inserting into the `media` table)
- Any server-side operations that need full database access
- Background jobs and scripts

**Security Note:** The admin client should ONLY be used in:
- API routes (server-side)
- Server actions
- Background scripts
- NEVER in client components or exposed to the browser

### Image Upload Flow
1. User clicks upload area â†’ File explorer opens immediately
2. User selects file â†’ Preview shown with loading state
3. File uploaded to Supabase Storage bucket
4. Record created in `media` table (using admin client)
5. Public URL returned and set in form

### Database Schema Update
The `daily_rate` column was added as `VARCHAR(50)` to allow flexible formatting:
- "$50/day"
- "Call for pricing"
- "Contact us"
- Or just "50"

This gives you flexibility in how you display pricing information.

---

## Files Modified Summary

1. **lib/supabase/admin.ts** - Already existed (admin client)
2. **app/api/cms/media/upload/route.ts** - Uses admin client
3. **components/cms/forms/image-upload.tsx** - Simplified upload UX
4. **docs/v2/SCHEMA_V1.sql** - Added daily_rate column
5. **docs/v2/migrations/add-daily-rate-to-rentals.sql** - Migration file

---

All fixes are complete! Just run the migration and you should be good to go. ðŸŽ‰
